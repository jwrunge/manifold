<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Manifold Demo</title>

		<style>
			.red {
				color: red;
			}

			html {
				background: black;
				color: lightgray;
			}

			input {
				background: gray;
				color: white;
			}

			@keyframes list-item {
				from {
					opacity: 0;
					transform: translateX(20px);
				}
				to {
					opacity: 1;
					transform: translateX(0);
				}
			}

			@keyframes list-item-out {
				from {
					opacity: 1;
					transform: translateX(0);
				}
				to {
					opacity: 0;
					transform: translateX(-20px);
				}
			}

			/* Separate animations for new vs old snapshots */
			::view-transition-new(*.list-item) {
				animation: list-item 300ms ease both;
			}
			::view-transition-old(*.list-item) {
				animation: list-item-out 300ms ease both;
			}

			.mf-hidden {
				display: none;
			}
		</style>
	</head>

	<body data-mf-register class="mf-hidden">
		<input
			:value="count"
			:type="count === 3 || count === 5 ? 'text' :
		'number'"
			:class:red="count % 5 === 0"
			:style:background-color="count %
		2 === 0 ? 'lightblue' : 'lightgreen'"
			:onclick="(e)=>
		popup(e.target.value)"
			:something="count * 2"
		/>

		<input type="number" :sync:value="count" />

		<div :if="count < 10" :transition="list-item">
			The count is less than 10! ${count}
		</div>
		<div :elseif="count < 20" :transition="list-item">
			The count is between 10 and 19! ${count}
		</div>
		<div :elseif="count < 30" :transition="list-item">
			The count is between 20 and 29! ${count}
		</div>
		<div :else :transition="list-item">
			The count is 30 or more! ${count}
		</div>
		<div>Count squared is ${count * count}</div>

		<!-- Await / Then / Catch demo with reload toggle -->
		<div style="margin-top: 1rem">
			<button :onclick="loadUser()" style="margin-bottom: 0.5rem">
				Reload User (alternates success/error)
			</button>
			<div :await="currentUserPromise">Loading user...</div>
			<div :then="user">
				User loaded: ${user.name} (${user.age}) ${count}
			</div>
			<div :catch="errorMsg" style="color: red">
				Failed to load user: ${errorMsg}
				<p>Here is a list of all the error messages:</p>
				<ul>
					<li>${errorMsg}</li>
					<li :each="['Error A', 'Error B', 'Error C'] as msg, idx">
						#${idx} ${msg}: ${errorMsg}
					</li>
				</ul>
			</div>
		</div>

		<!-- Each demo -->
		<div style="margin-top: 1rem" transition>
			<div>Family Members:</div>
			<ul>
				<li :each="someArray as {name, age}">
					${name} (${age} years old) ${count}
				</li>
			</ul>
		</div>

		<!-- Final -->
		<div style="margin-top: 1rem" :if="list.length > 2">
			<div>Family Members:</div>
			<ul>
				<li
					class="list-item"
					:transition="list-item"
					:each="list as { id, text }, key"
				>
					${key}: ${id} ${text}
					<button :onclick="removeFromList(key)">REMOVE</button>
				</li>
			</ul>
		</div>
		<button :onclick="addToList()">Add to List</button>
		<button :onclick="list.pop()">Remove from List</button>

		<p>End content</p>

		<script type="module">
			window.__MF_DEBUG_EACH = true;
			import $ from "./src/main.ts";
			const myState = $.create()
				.add("count", 0)
				.add("popup", (e) => console.log(e))
				.add("nextFail", false)
				.add("currentUserPromise", null)
				.add("someArray", [
					{ name: "Jake", age: 37 },
					{ name: "Mary", age: 37 },
					{ name: "Isaac", age: 6 },
					{ name: "Elinor", age: 4 },
				])
				.add("list", [
					{ id: 1, text: "Item 1" },
					{ id: 2, text: "Item 2" },
					{ id: 3, text: "Item 3" },
				])
				.add("addToList", () => {
					const nextId = myState.list.length
						? myState.list[myState.list.length - 1].id + 1
						: 1;
					myState.list.push({ id: nextId, text: `Item ${nextId}` });
				})
				.add("removeFromList", (key) => {
					myState.list.splice(key, 1);
				})
				.build();

			myState.loadUser = () => {
				const fail = !!myState.nextFail;
				myState.nextFail = !fail;

				const p = new Promise((res, rej) =>
					setTimeout(() => {
						if (fail) console.log("REJECTING PROMISE");
						else console.log("RESOLVING PROMISE");

						if (fail) rej(new Error("Network"));
						else
							res({
								name: "Ada",
								age: 37 + Math.floor(Math.random() * 10),
							});
					}, 800)
				);
				myState.currentUserPromise = p;

				// p.then(
				// 	(u) => (myState.user = u),
				// 	(err) =>
				// 		(myState.errorMsg =
				// 			err && err.message ? err.message : String(err))
				// );
				return p;
			};

			// Initial load
			myState.loadUser();
		</script>
	</body>
</html>
