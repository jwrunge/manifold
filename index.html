<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Manifold Demo</title>

		<style>
			.red {
				color: red;
			}

			html {
				background: black;
				color: lightgray;
			}

			input {
				background: gray;
				color: white;
			}
		</style>
	</head>

	<body data-mf-register>
		<input
			:value="count"
			:type="count === 3 || count === 5 ? 'text' :
		'number'"
			:class:red="count % 5 === 0"
			:style:background-color="count %
		2 === 0 ? 'lightblue' : 'lightgreen'"
			:onclick="(e)=>
		popup(e.target.value)"
			:something="count * 2"
		/>

		<input type="number" :sync:value="count" />

		<div :if="count < 10">The count is less than 10! ${count}</div>
		<div :elseif="count < 20">The count is between 10 and 19! ${count}</div>
		<div :elseif="count < 30">The count is between 20 and 29! ${count}</div>
		<div :else>The count is 30 or more! ${count}</div>
		<div>Count squared is ${count * count}</div>

		<!-- Await / Then / Catch demo with reload toggle -->
		<div style="margin-top:1rem;">
			<button :onclick="loadUser()" style="margin-bottom:.5rem;">Reload User (alternates success/error)</button>
			<div :await="currentUserPromise">Loading user...</div>
			<div :then>User loaded: ${user.name} (${user.age})</div>
			<div :catch style="color:red;">Failed to load user: ${errorMsg}</div>
		</div>
			</div>
		</div>

		<script type="module">
			import $ from "./dist/manifold.js";
			const myState = $.create()
				.add("count", 0)
				.add("popup", (e) => console.log(e))
				.add("user", { name: "(pending)", age: 0 })
				.add("errorMsg", "")
				.add("nextFail", false)
				.add("currentUserPromise", null)
				.build();

			myState.loadUser = () => {
				myState.errorMsg = "";
				const fail = !!myState.nextFail;
				myState.nextFail = !fail;
				const p = new Promise((res, rej) =>
					setTimeout(() => {
					if(fail) console.log("REJECTING PROMISE");
					else console.log("RESOLVING PROMISE");

						if (fail) rej(new Error("Network"));
						else res({ name: "Ada", age: 37 + Math.floor(Math.random()*10) });
					}, 800)
				);
				myState.currentUserPromise = p;
				p.then(
					(u) => (myState.user = u),
					(err) => (myState.errorMsg = err && err.message ? err.message : String(err))
				);
				return p;
			};

			// Initial load
			myState.loadUser();

			// setInterval(() => {
			// 	myState.count += 1;
			// }, 1000);
		</script>
	</body>
</html>
